From b65439c4025039871f34fd6a078b283d05220584 Mon Sep 17 00:00:00 2001
From: AD-Aleksandrov <aleksandr.aleksandrov@emlid.com>
Date: Thu, 30 Nov 2017 18:48:48 +0300
Subject: [PATCH] net: rfkill-gpio, arm64: dts: allwinner: enable rfkill
 switcher for bt

---
 arch/arm64/boot/dts/allwinner/sun50i-h5-emlid-iota.dts | 14 ++++++++++++++
 net/rfkill/rfkill-gpio.c                               |  6 ++++++
 2 files changed, 20 insertions(+)

diff --git a/arch/arm64/boot/dts/allwinner/sun50i-h5-emlid-iota.dts b/arch/arm64/boot/dts/allwinner/sun50i-h5-emlid-iota.dts
index c9251aa..668e503 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-h5-emlid-iota.dts
+++ b/arch/arm64/boot/dts/allwinner/sun50i-h5-emlid-iota.dts
@@ -79,6 +79,15 @@
         reset-gpios = <&pio 0 9 GPIO_ACTIVE_LOW>; /* PA9 */
         post-power-on-delay-ms = <200>;
     };
+
+    bcm43xx {
+        compatible = "rfkill-gpio";
+        pinctrl-names = "default";
+        pinctrl-0 = <&bt_rst_n_pin>;
+        reset-gpios = <&pio 0 10 GPIO_ACTIVE_HIGH>;     /* PA10 */
+        name = "bcm43xx";
+        type = "bluetooth";
+    };
 };
 
 &r_pio {
@@ -157,6 +166,11 @@
         pins = "PA13";
         function = "gpio_out";
     };
+
+    bt_rst_n_pin: bt_rst_n_pin@0 {
+        pins = "PA10";
+        function = "gpio_out";
+    };
 };
 
 &spi0 {
diff --git a/net/rfkill/rfkill-gpio.c b/net/rfkill/rfkill-gpio.c
index 41bd496..1c8bf98 100644
--- a/net/rfkill/rfkill-gpio.c
+++ b/net/rfkill/rfkill-gpio.c
@@ -165,12 +165,18 @@ static const struct acpi_device_id rfkill_acpi_match[] = {
 MODULE_DEVICE_TABLE(acpi, rfkill_acpi_match);
 #endif
 
+static const struct of_device_id rfkill_of_match[] = {
+	{ .compatible = "rfkill-gpio", },
+	{ },
+};
+
 static struct platform_driver rfkill_gpio_driver = {
 	.probe = rfkill_gpio_probe,
 	.remove = rfkill_gpio_remove,
 	.driver = {
 		.name = "rfkill_gpio",
 		.acpi_match_table = ACPI_PTR(rfkill_acpi_match),
+		.of_match_table = of_match_ptr(rfkill_of_match),
 	},
 };
 
-- 
2.7.4

